---
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "style.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: "16:9"
      #beforeInit: "macros.js"
    includes:
      in_header: header.html
    seal: false
always_allow_html: true
tables: true
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.showtext = TRUE)
#knitr::opts_chunk$set(cache=TRUE)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(PrettyCols)
cols = prettycols("Relax")
col1 = cols[1]
col2 = cols[2]
col3 = cols[3]
col4 = cols[4]
col5 = cols[5]

library(xaringanthemer)

theme_xaringan(
  text_color = "#333f48",
  background_color = "#FFFFFF",
  accent_color = "#820a94",
  text_font = "Fira Mono",
  text_font_use_google = TRUE,
  title_font = "Fira Sans Condensed",
  title_font_use_google = TRUE
)

style_mono_accent(
  #base_color = "#bf5700",
  extra_fonts = list(google_font("Fira Sans","200","300","400","500","600"),
                     google_font("Fira Sans Condensed"),
                     google_font("Jost")),
  base_color = "#333f48",
  header_font_google = google_font("Yanone Kaffeesatz","200","300","400","500","600","700"),
  text_font_google   = google_font("Jost"),
  code_font_google   = google_font("Fira Mono"),
  text_bold_color = "#333f48",
  text_font_size = "130%",
  colors = c(
    red = "#f34213",
    purple = "#820a94",
    orange = "#ff8811",
    green = "#136f63",
    white = "#FFFFFF",
    darkorange = "#0F8D94",
    coolblue = "#4493AE",
    darkgrey = "#A9A9A9"),
  extra_css = list(
    ".body" = list("font-family" = "Jost"),
    ".remark-slide table" = list("display" = "table",
                   "width" = "80%",
                   "text-align" = "left"),
    
    #".remark-slide-number" = list("display" = "none"),
    
    ".strong" = list("font-weight" = "400"),
    ".big" = list("font-size" = "250%",
                     "font-family" = "Yanone Kaffeesatz",
                     "font-weight"="400"),
    ".small" = list("font-size" = "80%"),
    ".smaller" = list("font-size" = "70%"),
    ".tiny" = list("font-size" = "50%"),
    ".tinylist" = list("font-size" = "62.5%"),
    ".source" = list("color" = "#8c8c8c",
                     "font-size" = "80%"),
    ".remark-slide table td#highlight" = list("background-color" = "#eee1f0",
                                  "color" = "#820a94",
                                  "font-weight" = "500"),
   # ".remark-slide table thead th" = list(),
    ".title-slide h1" = list("font-weight" = "500"),
    ".title-slide h2" = list("font-weight" = "400",
                             "font-size" =  "100%",
                             "font-family" = "Jost"),
    ".title-slide h3" = list("font-family" = "Jost",
                             "font-size" = "80%",
                             "font-weight" = "200"),
    ".center2" = list("margin" = "0",
                      "position" = "absolute",
                      "top" = "50%",
                      "left" = "50%",
                      "-ms-transform" = "translate(-50%, -50%)",
                      "transform" = "translate(-50%, -50%)"),
    ".section-title h1" = list("color" = "#FFFFFF",
                               "font-size" = "2.3em",
                               "line-height" = "1.3"),
    ".medium" = list("font-size" = "1.4em"),
    ".sp-after-half" = list("margin-bottom" = "0.7em !important"),
    ".box-1,.box-1a,.box-1s,.box-1b,.box-1l,.box-1LA,.section-title-1" = list("background-color" = "#3b0768",
                                                                              "border-radius" = "15px"),
    ".box-2,.box-2a,.box-2s,.box-2b,.box-2l,.box-2LA,.section-title-2" = list("background-color" = "#291594",
                                                                              "border-radius" = "15px"),
    ".box-3,.box-3a,.box-3s,.box-3b,.box-3l,.box-3LA,.section-title-3" = list("background-color" = "#820a94",
                                                                              "border-radius" = "15px"),
    ".box-4,.box-4a,.box-4s,.box-4b,.box-4l,.box-4LA,.section-title-4" = list("background-color" = "#BF3984",
                                                                              "border-radius" = "15px"),
    ".box-5,.box-5a,.box-5s,.box-5b,.box-5l,.box-5LA,.section-title-5" = list("background-color" = "#f87241",
                                                                              "border-radius" = "15px"),
    ".box-6,.box-6a,.box-6s,.box-6b,.box-6l,.box-6LA,.section-title-6" = list("background-color" = "#F89441",
                                                                              "border-radius" = "15px"),
    ".box-7,.box-7a,.box-7s,.box-7b,.box-7l,.box-7LA,.section-title-7" = list("background-color" = "#f8c741",
                                                                              "border-radius" = "15px"),
   
    ".box-7, .box-6, .box-5, .box-4, .box-3, .box-2, .box-1" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "31px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                    "font-family" = "Jost"),
    ".box-7a, .box-6a, .box-5a, .box-4a, .box-3a, .box-2a, .box-1a" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.4em 0.4em",
                                                                      "font-weight" = "600",
                                                                      "font-size" = "25px",
                                                                      "display" = "table",
                                                                      "text-align" = "center",
                                                                      "font-family" = "Fira Sans"),
       ".box-7b, .box-6b, .box-5b, .box-4b, .box-3b, .box-2b, .box-1b" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.4em 0.4em",
                                                                      "font-weight" = "600",
                                                                      "font-size" = "25px",
                                                                      "display" = "table",
                                                                      "text-align" = "left",
                                                                      "font-family" = "Fira Sans"),
       ".medium" = list("font-size" = "1.4em"),
    ".sp-after-half" = list("margin-bottom" = "0.7em !important"),
    ".box-0" = list("background-color" = "#DAE058",
                    "border-radius" = "15px",
                    "font-size" = "110%",
                    "color" = "#FFFFFF",
                    "margin" = "0em auto",
                    "overflow" = "hidden",
                    "padding" = "0.4em 0.4em",
                    "display" = "table"),
    # ".box-1,.box-1a,.box-1s,.box-1b,.box-1l,.box-1LA,.section-title-1" = list("background-color" = "#6e077d",
    #                                                                           "border-radius" = "15px"),
    # ".box-2,.box-2a,.box-2s,.box-2b,.box-2l,.box-2LA,.section-title-2" = list("background-color" = "#800791",
    #                                                                           "border-radius" = "15px"),
    # ".box-3,.box-3a,.box-3s,.box-3b,.box-3l,.box-3LA,.section-title-3" = list("background-color" = "#820a94",
    #                                                                           "border-radius" = "15px"),
    # ".box-4,.box-4a,.box-4s,.box-4b,.box-4l,.box-4LA,.section-title-4" = list("background-color" = "#A5AC20",
    #                                                                           "border-radius" = "15px"),
    # ".box-5,.box-5a,.box-5s,.box-5b,.box-5l,.box-5LA,.section-title-5" = list("background-color" = "#f28122",
    #                                                                           "border-radius" = "15px"),
    # ".box-6,.box-6a,.box-6s,.box-6b,.box-6l,.box-6LA,.section-title-6" = list("background-color" = "#F89441",
    #                                                                           "border-radius" = "15px"),
    # ".box-7,.box-7a,.box-7s,.box-7b,.box-7l,.box-7LA,.section-title-7" = list("background-color" = "#faa055",
    #                                                                           "border-radius" = "15px"),
   
   ".box-1t,.box-1tL,.section-title-1t" = list("background-color" = "rgba(13, 8, 135,0.3)",
                                      "color"="rgba(13, 8, 135,1)",
                                      "font-family" = "Yanone Kaffeesatz",
                                      "border-radius" = "15px"),
    ".box-2t,.box-2tL,.section-title-2t" = list("background-color" = "rgba(86, 1, 164,0.3)",
                                       "color" = "rgba(86, 1, 164,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                       "border-radius" = "15px"),
    ".box-3t,.box-3tL,.section-title-3t" = list("background-color" = "rgba(144, 13, 164,0.3)",
                                       "color" = "rgba(144, 13, 164,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                       "border-radius" = "15px"),
    ".box-4t,.box-4tL,.section-title-4t" = list("background-color" = "rgba(191, 57, 132,0.3)",
                                       "color" = "rgba(191, 57, 132,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                       "border-radius" = "15px"),
    ".box-5t,.box-5tL,.section-title-5t" = list("background-color" = "rgba(225, 100, 98,0.3)",
                                       "color" = "rgba(225, 100, 98,1)",
                                       "font-family" = "Jost",
                                       "border-radius" = "15px"),
    ".box-6t,.box-6tL,.section-title-6t" = list("background-color" = "rgba(248, 148, 65,0.3)",
                                       "color" = "rgba(248, 148, 65,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                       "border-radius" = "15px"),
    ".box-7t,.box-7tL,.section-title-7t" = list("background-color" = "rgba(252, 206, 37,0.3)",
                                       "color" = "rgba(252, 206, 37,1)",
                                       "font-family" = "Yanone Kaffeesatz",
                                       "border-radius" = "15px"),
   
   ".box-7t, .box-6t, .box-5t, .box-4t, .box-3t, .box-2t, .box-1t" = list("margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "25px",
                                                                    "display" = "table",
                                                                    "text-align" = "center"),
   
   ".box-7tL, .box-6tL, .box-5tL, .box-4tL, .box-3tL, .box-2tL, .box-1tL" = list("margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "50px",
                                                                    "display" = "table",
                                                                    "text-align" = "center"),
   
    ".box-7, .box-6, .box-5, .box-4, .box-3, .box-2, .box-1" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "31px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                    "font-family" = "Jost"),
    ".box-7a, .box-6a, .box-5a, .box-4a, .box-3a, .box-2a, .box-1a" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.4em 0.4em",
                                                                      "font-weight" = "600",
                                                                      "font-size" = "25px",
                                                                      "display" = "table",
                                                                      "text-align" = "center",
                                                                      "font-family" = "Yanone Kaffeesatz"),
   ".box-7s, .box-6s, .box-5s, .box-4s, .box-3s, .box-2s, .box-1s" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.2em 0.2em",
                                                                      "font-weight" = "400",
                                                                      "font-size" = "100%",
                                                                      "display" = "inline",
                                                                      "text-align" = "center",
                                                                      "font-family" = "Yanone Kaffeesatz"),
       ".box-7b, .box-6b, .box-5b, .box-4b, .box-3b, .box-2b, .box-1b" = list("color" = "#FFFFFF",
                                                                          "left" = "0px",
                                                                          "overflow" = "hidden",
                                                                      "padding" = "0.4em 0.4em",
                                                                      "font-weight" = "600",
                                                                      "font-size" = "25px",
                                                                      "display" = "table",
                                                                      "text-align" = "left",
                                                                      "font-family" = "Yanone Kaffeesatz"),
   ".box-7l, .box-6l, .box-5l, .box-4l, .box-3l, .box-2l, .box-1l" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "45px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                      "font-family" = "Yanone Kaffeesatz"),
   ".box-7LA, .box-6LA, .box-5LA, .box-4LA, .box-3LA, .box-2LA, .box-1LA" = list("color" = "#FFFFFF",
                                                                    "margin" = "0em auto",
                                                                    "overflow" = "hidden",
                                                                    "padding" = "0.4em 0.4em",
                                                                    "font-weight" = "600",
                                                                    "font-size" = "55px",
                                                                    "display" = "table",
                                                                    "text-align" = "center",
                                                                      "font-family" = "Yanone Kaffeesatz"),
       ".box-1trans,.box-2trans,.box-3trans,.box-4trans,.box-5trans,.box-6trans,.box-7trans" = list("background-color" = "#FFFFFF",
                                                                                                 "font-family" = "Jost",
                                                                                                 "border-radius" = "15px",
                                                                                                 "margin" = "0em auto",
                                                                                                 "overflow" = "hidden",
                                                                                                 "padding" = "0.4em 0.4em",
                                                                                                 "font-weight" = "400",
                                                                                                 "font-size" = "25px",
                                                                                                 "display" = "table",
                                                                                                 "text-align" = "center",
                                                                                                 "border-width" = "thick",
                                                                                                 "color" = "#333f48"),
   
       ".box-1Trans,.box-2Trans,.box-3Trans,.box-4Trans,.box-5Trans,.box-6Trans,.box-7Trans" = list("background-color" = "#FFFFFF",
                                                                                                 "font-family" = "Yanone Kaffeesatz",
                                                                                                 "border-radius" = "15px",
                                                                                                 "margin" = "0em auto",
                                                                                                 "overflow" = "hidden",
                                                                                                 "padding" = "0.4em 0.4em",
                                                                                                 "font-weight" = "600",
                                                                                                 "font-size" = "51px",
                                                                                                 "display" = "table",
                                                                                                 "text-align" = "center",
                                                                                                 "border-width" = "thick",
                                                                                                 "color" = "#333f48"),
   
       ".box-1transl,.box-2transl,.box-3transl,.box-4transl,.box-5transl,.box-6transl,.box-7transl" = list("background-color" = "#FFFFFF",
                                                                                                           "font-family" = "Yanone Kaffeesatz",
                                                                                                           "border-radius" = "15px",
                                                                                                           "left" = "0px",
                                                                                                           "overflow" = "hidden",
                                                                                                           "padding" = "0.4em 0.4em",
                                                                                                           "font-weight" = "400",
                                                                                                           "font-size" = "31px",
                                                                                                           "display" = "table",
                                                                                                           "text-align" = "left",
                                                                                                           "border-width" = "thick",
                                                                                                           "color" = "#333f48"),
   
   
    ".box-1trans,.box-1transl,.box-1Trans" = list("border"="5px solid #4B3F72"),
    ".box-2trans,.box-2transl,.box-2Trans" = list("border"="5px solid #CBB3BF"),
    ".box-3trans,.box-3transl,.box-3Trans" = list("border"="5px solid #FFC857"),
    ".box-4trans,.box-4transl,.box-4Trans" = list("border"="5px solid #119DA4"),
    ".box-5trans,.box-5transl,.box-5Trans" = list("border"="5px solid #19647E"),
    ".box-6trans,.box-6transl,.box-6Trans" = list("border"="5px solid #0F8D94"),
    ".box-7trans,.box-7transl,.box-7Trans" = list("border"="5px solid #f8c741"),
   
   ".image-80 img" = list("scale" = "80%"),
   ".pull-left-little_l" = list("float" = "left",
                                "width" = "57%"),
   ".pull-right-little_l" = list("float" = "right",
                                "width" = "37%"),
   ".pull-left-little_r" = list("float" = "left",
                                "width" = "27%"),
   ".pull-right-little_r" = list("float" = "right",
                                "width" = "67%")

  )
)

#,"li" = list("font-size" = "150%")
#    "li" = list("font-size" = "110%"),
#    "ul" = list("font-size" = "110%"),
#color palette
#5601A4
#820a94
#F89441
#FCCE25
```

```{r setup2, echo=FALSE, message=FALSE, warning = FALSE}
library(knitr)
library(showtext)
library(xaringanExtra)

options(knitr.table.format = "html") 

#xaringanExtra::use_scribble()

```

```{r fonts, message=FALSE, echo=FALSE, warning = FALSE}
font_add_google("Fira Sans Condensed", "Fira Sans Condensed")
font_add_google("Fira Sans", "Fira Sans")
font_add_google("Jost", "Jost")
showtext_auto()
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggthemes)
library(ggplot2)
library(firasans)
library(hrbrthemes)
library(extrafont)
library(RColorBrewer)
library(firasans)
library(hrbrthemes)
library(extrafont)
library(gridExtra)
library(pBrackets)
library(patchwork)

#loadfonts(device = "win")

options(scipen = 0)
```

class: inverse, center, middle

<br>
<br>
<br>

<h1 class="title-own">Difference-in-Differences<br/>using Mixed-Integer Programming Matching Approach</h1>

<br>
<br>
.small[Magdalena Bennett&nbsp;&nbsp;&nbsp;<br>*McCombs School of Business, The University of Texas at Austin*&nbsp;&nbsp;&nbsp;]

<br>

.small[AEFP 50th Conference, Washington DC<br>March 13th, 2025]

---
# Diff-in-Diff is very popular in Economics

```{r gg, fig.height=5, fig.align='center', dev='svg', echo=FALSE, warning=FALSE}
# Data updated 11/19/2024
d = read.csv("C:/Users/mc72574/Dropbox/Hugo/Sites/presentations/content/presentations/DD/ingUC_20241120/dd_pub_updated.csv")

#Data for publications (updated 06/2022 See excel)
#d = data.frame(cbind(as.numeric(seq(2021,2000,-1)),
#                     c(1380,
#953,
#806,
#635,
#489,
#386,
#265,
#226,
#164,
#125,
#77,
#67,
#56,
#45,
#28,
#19,
##23,
#22,
#5,
#4,
#6,
#3
#)))

names(d) = c("Year","Pub")

d = d %>% filter(Year >= 2000)

ggplot(d, aes(x = Year, y = Pub), fill="white") +
  geom_line(lwd=1.1, color = col4) +
  geom_point(size=3, color = col4) +
  theme_bw()+
  theme_ipsum_fsc(plot_title_face = "bold") + #plain 
  xlab("Year") + ylab("Num. Publications")+
  xlim(2000,2024) +
  
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=16),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=16),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=10),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))

```
.source[Source: Web of Science (11/18/2024)]

---
# Diff-in-Diff is very popular in Economics

```{r gg2, fig.height=5, fig.align='center', dev='svg', echo=FALSE, warning=FALSE}
ggplot(d, aes(x = Year, y = Pub), fill="white") +
  geom_line(lwd=1.1, color = col4) +
  geom_point(size=3, color = col4) +
  theme_bw()+
  theme_ipsum_fsc(plot_title_face = "bold") + #plain 
  xlab("Year") + ylab("Num. Publications")+
  xlim(2000,2024) +
  geom_vline(aes(xintercept = 2020), lty = 2, color = "darkgrey") +
  
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=16),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=16),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=10),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))

```
.source[Source: Web of Science (11/18/2024)]

---
# Diff-in-Diff as an identification strategy

```{r dd, fig.height=5, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(ggpubr)
library(hrbrthemes)
library(firasans)
#hrbrthemes::update_geom_font_defaults(family=font_rc)


#Traditional diff in diff:

Y1 = c(2,4)
Y0 = c(1,2)
Y1c = c(2,3)

d = data.frame(cbind(c(0,1,0,1),c(Y0,Y1),c(0,0,1,1)))
names(d) = c("t","Y","Z")

ggplot(d, aes(x = t, y = Y, group=factor(Z), color=factor(Z)), fill="white") +
  geom_line(lwd=1.1) +
  geom_point(size=3)+
  geom_vline(xintercept = 0.5,lty=2,col="dark grey",lwd=1)+
  #scale_color_manual(values=c("#F89441","#820a94")) +
  scale_color_manual(values=c(col2,col3)) +
  ggplot2::annotate("text",x=0.4,y=4.7,label = "Pre-Intervention", size=6, colour="dark grey",hjust=1, family="Fira Sans Condensed")+
  ggplot2::annotate("text",x=0.6,y=4.7,label = "Post-Intervention", size=6, colour="dark grey",hjust=0, family="Fira Sans Condensed")+
  
    ggplot2::annotate("rect",xmin=-1, xmax=-0.4,ymin=0,ymax=1,alpha=1, color="dark grey", fill="white")+
    ggplot2::annotate("segment",x=-0.95,y=0.3,xend=-0.8,yend=0.3,lty=1,col=col2,lwd=1) +
    ggplot2::annotate("text",x=-0.77,y=0.3,label = "Control", size=4, colour="black",hjust=0, 
             family="Fira Sans Condensed")+
    ggplot2::annotate("segment",x=-0.95,y=0.7,xend=-0.8,yend=0.7,lty=1,col=col3,lwd=1) +
    ggplot2::annotate("text",x=-0.77,y=0.7,label = "Treat", size=4, colour="black",hjust=0, 
             family="Fira Sans Condensed")+
  
  theme_bw()+
  theme_ipsum_fsc(plot_title_face = "bold") + #plain 
  xlab("Time") + ylab("Outcome")+
  xlim(-1,2) + ylim(0,5)+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=16),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=16),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=10),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))

```


---
# Parallel trend assumption (PTA)

```{r dd2, fig.height=5, fig.align='center', dev='svg', echo=FALSE, warning=FALSE}
#Traditional diff in diff:

ggplot(d, aes(x = t, y = Y, group=factor(Z), color=factor(Z)), fill="white") +
  geom_line(lwd=1.1) +
  geom_point(size=3)+
  geom_vline(xintercept = 0.5,lty=2,col="dark grey",lwd=1)+
  geom_segment(aes(x = 0, y = Y1[1], xend = 1, yend = Y1c[2]), lty=3,lwd=1,col=col3) +
  geom_point(aes(x=1,y=Y1c[2]),pch=1,col=col3, size=3) +
  scale_color_manual(values=c(col2,col3)) +
  
  ggplot2::annotate("text",x=0.4,y=4.7,label = "Pre-Intervention", size=6, colour="dark grey",hjust=1, family="Fira Sans Condensed")+
  ggplot2::annotate("text",x=0.6,y=4.7,label = "Post-Intervention", size=6, colour="dark grey",hjust=0, family="Fira Sans Condensed")+
  
    ggplot2::annotate("rect",xmin=-1, xmax=-0.4,ymin=0,ymax=1,alpha=1, color="dark grey", fill="white")+
    ggplot2::annotate("segment",x=-0.95,y=0.3,xend=-0.8,yend=0.3,lty=1,col=col2,lwd=1) +
    ggplot2::annotate("text",x=-0.77,y=0.3,label = "Control", size=4, colour="black",hjust=0, 
             family="Fira Sans Condensed")+
    ggplot2::annotate("segment",x=-0.95,y=0.7,xend=-0.8,yend=0.7,lty=1,col=col3,lwd=1) +
    ggplot2::annotate("text",x=-0.77,y=0.7,label = "Treat", size=4, colour="black",hjust=0, 
             family="Fira Sans Condensed")+
  
  theme_bw()+
  theme_ipsum_fsc(plot_title_face = "bold") + #plain 
  xlab("Time") + ylab("Outcome")+
  xlim(-1,2) + ylim(0,5)+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=16),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=16),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=10),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))
  

```

---
# Estimate Average Treatment Effect on the Treated (ATT)

```{r dd3, fig.height=5, fig.align='center', dev='svg', echo=FALSE, warning=FALSE}
#Traditional diff in diff:

ggplot(d, aes(x = t, y = Y, group=factor(Z), color=factor(Z)), fill="white") +
  geom_line(lwd=1.1) +
  geom_point(size=3)+
  geom_vline(xintercept = 0.5,lty=2,col="dark grey",lwd=1)+
  geom_segment(aes(x = 0, y = Y1[1], xend = 1, yend = Y1c[2]), lty=3,lwd=1,col=col3) +
  geom_point(aes(x=1,y=Y1c[2]),pch=1,col=col3, size=3) +
  geom_segment(aes(x=1+0.05,y=Y1c[2],xend=1+0.05,yend=Y1[2]),lwd=0.8,lty=1,
               arrow=arrow(length = unit(0.03, "npc"),type="closed"),arrow.fill=col4,col=col4) +
  scale_color_manual(values=c(col2,col3)) +
  
  ggplot2::annotate("text", x=1.1,y=3.5,label = bquote(""~tau),col=col4,size=10) + 
  ggplot2::annotate("text",x=0.4,y=4.7,label = "Pre-Intervention", size=6, colour="dark grey",hjust=1, family="Fira Sans Condensed")+
  ggplot2::annotate("text",x=0.6,y=4.7,label = "Post-Intervention", size=6, colour="dark grey",hjust=0, family="Fira Sans Condensed")+
  
    ggplot2::annotate("rect",xmin=-1, xmax=-0.4,ymin=0,ymax=1,alpha=1, color="dark grey", fill="white")+
    ggplot2::annotate("segment",x=-0.95,y=0.3,xend=-0.8,yend=0.3,lty=1,col=col2,lwd=1) +
    ggplot2::annotate("text",x=-0.77,y=0.3,label = "Control", size=4, colour="black",hjust=0, 
             family="Fira Sans Condensed")+
    ggplot2::annotate("segment",x=-0.95,y=0.7,xend=-0.8,yend=0.7,lty=1,col=col3,lwd=1) +
    ggplot2::annotate("text",x=-0.77,y=0.7,label = "Treat", size=4, colour="black",hjust=0, 
             family="Fira Sans Condensed")+
  
  theme_bw()+
  theme_ipsum_fsc(plot_title_face = "bold") + #plain 
  xlab("Time") + ylab("Outcome")+
  xlim(-1,2) + ylim(0,5)+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.line = element_line(colour = "dark grey"))+
  theme(axis.title.x = element_text(size=16),#margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.text.x = element_text(size=10),
        axis.title.y = element_text(size=16),#margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.text.y = element_text(size=10),legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=15),
        legend.background = element_rect(fill="white",colour ="white"),
        title = element_text(size=14))

```

---
# But what if the PTA doesn't hold?

<br>
<br>
.pull-left[
```{r po1, fig.height=6, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}
library(cowplot)

df <- data.frame(t = c(-2,-2,-2,-2,-1,-1,-1,-1,0,0,0,0,1,1,1,1),
                x = c(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),
                treat = c(0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1),
                outcome = c(1.2, 2.2, 1.1,2.5,1.3,2.3,0.9,2.7,1.4,2.4,0.7,2.9,1.5,3,0.5,3.7))

# Plot 1:

d2 = df %>% group_by(t,treat) %>% summarize_all(mean)

g1 = ggplot(data = d2, aes(x = t, y = outcome, color = factor(treat), fill = factor(treat)), linetype = factor(treat)) +
  geom_point(size = 3, stroke = 1, shape = 22) +
  geom_vline(aes(xintercept = 0.5), color = "dark grey", lty = 2, lwd = 1.1) + 
  geom_line(lwd = 1) +
  scale_fill_manual(values = c(alpha(col2, 0.3), alpha(col3, 0.3)), 
                    labels = c("Control", "Treat"), name = "Treat group", 
                    guide = guide_legend(nrow = 1)) +  # Two-row legend
  scale_color_manual(values = c(alpha(col2, 1), alpha(col3, 1)), 
                     labels = c("Control", "Treat"), name = "Treat group", 
                     guide = guide_legend(nrow = 1)) +  # Two-row legend
  scale_linetype_manual(values = c(2, 3), labels = c("Control", "Treat"), 
                        name = "Treat group") +
  xlab("Time") + ylab("Outcome") + ylim(0.5, 3.8) +
  theme_bw() +
  theme_ipsum_fsc(plot_title_face = "bold", plot_title_size = 24) + 
  theme(plot.margin = unit(c(1, 1, 0.5, 1.2), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_blank(),
        legend.position = "bottom",
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.background = element_rect(fill = "white", colour = "white"),
        title = element_text(size = 14)) + 
  guides(fill = guide_legend(title.position = "top", title.hjust=0.5))

g1

# Plot 2
g2 = ggplot(data = df, aes(x = t, y = outcome, color = factor(treat), fill = factor(treat), shape = factor(x), linetype = factor(x))) +
  geom_point(size = 3, stroke = 1) +
  geom_vline(aes(xintercept = 0.5), color = "dark grey", lty = 2, lwd = 1.1) + 
  geom_line(lwd=1) +
  scale_fill_manual(values = c(alpha(col2, 0.3), alpha(col3, 0.3)), 
                    labels = c("Control", "Treat"), name = "Treat group") +
  scale_color_manual(values = c(alpha(col2, 1), alpha(col3, 1)), 
                     labels = c("Control", "Treat"), name = "Treat group") +
  scale_shape_manual(values = c(21, 24), labels = c("X1", "X2"), name = "Covariate group") +
  scale_linetype_manual(values = c(2, 3), labels = c("X1", "X2"), 
                        name = "Covariate group") +
  xlab("Time") + ylab("Outcome") + ylim(0.5, 3.8) +
  theme_bw() +
  theme_ipsum_fsc(plot_title_face = "bold", plot_title_size = 24) + 
  theme(plot.margin = unit(c(1, 1, 0.5, 1.2), "cm"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 10),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_blank(),
        legend.position = "bottom",
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 14),
        legend.background = element_rect(fill = "white", colour = "white"),
        title = element_text(size = 14)) + 
  guides(
    fill = guide_legend(title.position = "top", title.hjust = 0.5),
    shape = guide_legend(title.position = "top", title.hjust = 0.5, 
                         override.aes = list(color = "black")))

# Create subcaptions as separate text plots
caption_g1 = ggdraw() + draw_label("(a) Complete data", hjust = 0.5, size = 8)
caption_g2 = ggdraw() + draw_label("(b) Disaggregated data by covariates", hjust = 0.5, size = 8)

# Combine plots and captions
combined_plot = plot_grid(
  plot_grid(g1, g2, ncol = 2, rel_widths = c(1, 1)),
  plot_grid(caption_g1, caption_g2, ncol = 2),
  ncol = 1,
  rel_heights = c(1, 0.05) # Adjust the height of the captions row
)


#g1 + g2 + plot_layout(guides = "collect") & theme(legend.position='bottom')
```
]

---
# But what if the PTA doesn't hold?

.box-6trans[We can potentially remove [part of] the bias by matching on <i>X<sup>s</sup><sub>it</sub>=X<sub>i</sub></i>]

.pull-left[
```{r po2, fig.height=6, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}

g1

```
]

.pull-right[
```{r po3, fig.height=6, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}
g2
``` 
]

---

# This paper

- Identify contexts when matching can recover causal estimates under **.darkorange[certain violations of the parallel trend assumption]**.

  - Overall <u>bias reduction</u> and increase in <u>robustness for sensitivity analysis</u>.


- Use **.darkorange[mixed-integer programming matching (MIP)]** to balance covariates directly.

--
<br/>
<br/>

.pull-left[
.box-6trans[**Simulations:**<br/>Different DGP scenarios]
]

.pull-right[
.box-6trans[**Application:**<br/>School segregation & vouchers]
]

---

background-position: 50% 50%
class: left, bottom, inverse
.big[
Let's set up the problem
<br>
<br>
]

---

# DD Setup

- Let $Y_{it}(z)$ be the potential outcome for unit $i$ in period $t$ under treatment $z$.

- Intervention implemented in $T_0$ $\rightarrow$ No units are treated in $t\leq T_0$
--

- Difference-in-Differences (DD) focuses on ATT for $t>T_0$:

$$ATT(t) = E[Y_{it}(1) - Y_{it}(0)|Z=1]$$

--

.box-6trans[Expected difference in potential outcomes<br>*if the treatment hadn't happened*<br>**for the treatment group**]
  
---

# DD Setup

- Let $Y_{it}(z)$ be the potential outcome for unit $i$ in period $t$ under treatment $z$.

- Intervention implemented in $T_0$ $\rightarrow$ No units are treated in $t\leq T_0$

- Difference-in-Differences (DD) focuses on ATT for $t>T_0$:

$$ATT(t) = E[Y_{it}(1) - Y_{it}(0)|Z=1]$$


- **.darkorange[Assumptions for DD]**:

  - Parallel-trend assumption (PTA)
  
  - Common shocks
  
  $$E[Y_{i1}(0) - Y_{i0}(0) | Z=1] = E[Y_{i1}(0) - Y_{i0}(0) | Z=0]$$
---
# DD Setup (cont.)

- Under these assumptions:
$$
\begin{align}
\hat{\tau}^{DD} = &\color{#FFC857}{\overbrace{\color{black}{E[Y_{i1}|Z=1] - E[Y_{i1}|Z=0]}}^{\color{#FFC857}{\Delta_{post}}}} - \\
&\color{#CBB3BF}{\underbrace{\color{black}{(E[Y_{i0}|Z=1] - E[Y_{i0}|Z=0])}}_{\color{#CBB3BF}{\Delta_{pre}}}}
\end{align}
$$
  - Where $t=0$ and $t=1$ are the pre- and post-intervention periods, respectively.
  
  - $Y_{it} = Y_{it}(1)\cdot Z_i + (1-Z_i)\cdot Y_{it}(0)$ is the observed outcome.

---
# Bias in a DD setting

Bias can be introduced to DD in three ways:

-- 

1) **.darkorange[Time-invariant covariates with time-varying effects]**: $\gamma_1(X_i,t) \ \ \forall \ Z$
  - e.g. Effect of gender on salaries.
  
--

2) **.darkorange[Time-varying covariates or differential time-varying effects]**: $\gamma_2(X_i,t)$

  - e.g. Test scores evolution between groups; effect of gender on salaries evolve differently over time by group.

--

3) **.darkorange[Unobserved time-varying effects]**: $u_{it}$

---
# General form of potential outcomes

We can write a general form of the potential outcomes $Y(0)$ and $Y(1)$ as follows:

$$Y_{it}(0) =  \alpha_i + \lambda_{t} + \gamma_0(X_{i}) + \gamma_1(X_i,t) + \gamma_2(X_i,t)\cdot Z_i + u_{it}$$

$$Y_{it}(1) = Y_{it}(0) + \tau_{it} =  \alpha_i + \lambda_t + \gamma_0(X_{i}) + \gamma_1(X_i,t) + \gamma_2(X_i,t)\cdot Z_i + \tau_{it} + u_{it}$$
--

  .box-6trans[Covariate distribution between groups can be **different**<br>$$X_i|Z \sim F_x(z)$$]

---
# General form of potential outcomes

We can write a general form of the potential outcomes $Y(0)$ and $Y(1)$ as follows:

$$Y_{it}(0) =  \color{#119DA4}{\mathbf{\alpha_i + \lambda_{t}}} + \gamma_0(X_{i}) + \gamma_1(X_i,t) + \gamma_2(X_i,t)\cdot Z_i + u_{it}$$

- $\alpha_i$ and $\lambda_t$ are individual and time FE, respectively.
  - If $\lambda_t|Z \sim F_{\lambda}(z,t)$, then PTA fails.
  


---
# General form of potential outcomes

We can write a general form of the potential outcomes $Y(0)$ and $Y(1)$ as follows:

$$Y_{it}(0) =  \alpha_i + \lambda_{t} + \color{#119DA4}{\mathbf{\gamma_0(X_{i})}} + \gamma_1(X_i,t) + \gamma_2(X_i,t)\cdot Z_i + u_{it}$$

.darkgrey[- $\alpha_i$ and $\lambda_t$ are individual and time FE, respectively.
  - If $\lambda_t|Z \sim F_{\lambda}(z,t)$, then PTA fails.]
  
- $\gamma_0(X_i)$ is a time-invariant function that associates $X$ and $Y$


---
# General form of potential outcomes

We can write a general form of the potential outcomes $Y(0)$ and $Y(1)$ as follows:

$$Y_{it}(0) =  \alpha_i + \lambda_{t} + \gamma_0(X_{i}) + \color{#119DA4}{\mathbf{\gamma_1(X_i,t)}} + \gamma_2(X_i,t)\cdot Z_i + u_{it}$$

.darkgrey[- $\alpha_i$ and $\lambda_t$ are individual and time FE, respectively.
  - If $\lambda_t|Z \sim F_{\lambda}(z,t)$, then PTA fails.
  
- $\gamma_0(X_i)$ is a time-invariant function that associates $X$ and $Y$.]

- $\gamma_1(X_i,t)$ is a time-dependent function.


---
# General form of potential outcomes

We can write a general form of the potential outcomes $Y(0)$ and $Y(1)$ as follows:

$$Y_{it}(0) =  \alpha_i + \lambda_{t} + \gamma_0(X_{i}) + \gamma_1(X_i,t) + \color{#119DA4}{\mathbf{\gamma_2(X_i,t)\cdot Z_i}} + u_{it}$$

.darkgrey[- $\alpha_i$ and $\lambda_t$ are individual and time FE, respectively.
  - If $\lambda_t|Z \sim F_{\lambda}(z,t)$, then PTA fails.
  
- $\gamma_0(X_i)$ is a time-invariant function that associates $X$ and $Y$.

- $\gamma_1(X_i,t)$ is a time-dependent function.]

- $\gamma_2(X_i,t)\cdot Z_i$ is a _differential_ time-dependent function **only** for the treatment group.

---
# If the PTA holds...

Then, for a 2x2 DD, where $t<T_0$ (pre) and $t'>T_0$ (post):

$$\mathbb{E}[\gamma_1(X_{i}, t') + \gamma_2(X_{i}, t') - \gamma_1(X_{i}, t) - \gamma_2(X_{i}, t)|Z=1] = \mathbb{E}[\gamma_1(X_{i}, t') - \gamma_1(X_{i}, t)|Z=0]$$
--

**.darkorange[One of the two]** conditions need to hold:

1) No effect or constant effect of $X$ on $Y$ over time: $\mathbb{E}[\gamma_1(X,t)] = \mathbb{E}[\gamma_1(X)]$

2) Equal distribution of observed covariates between groups: $X_i|Z=1 \overset{d}{=} X_i|Z=0$

--
<br>

**.darkorange[in addition to]**:

3) No differential time effect of $X$ on $Y$ by treatment group: $\mathbb{E}[\gamma_2(X,t)] = 0$

--

<br>

.pull-left[
.box-6trans[**Cond. 2** can hold through **matching**]
]
--
.pull-right[
.box-6trans[**Cond. 3** can be tested with **sensitivity analysis**]
]
---
# Sensitivity analysis for Diff-in-Diff

- Use of **.darkorange[pre-trends]** to test plausibility of the PTA:

```{r dd_placebo, fig.height=5, fig.width=6, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}

dta = data.frame(time = rep(1:10,2),
                 treat = c(rep(0,10), rep(1,10)))

dta = dta %>% mutate(a = ifelse(treat == 0, 1, 2),
                     y = a + time,
                     y = ifelse(treat == 1 & time > 5, y + (time-6)*1.2, y))

ggplot(data = dta, aes(x = time, y = y, color = factor(treat))) +
  geom_point(size = 3)+
  geom_line(lwd = 1) +
  geom_vline(aes(xintercept = 6), lty = 2, lwd = 1.1, color = "darkgrey") +
  scale_color_manual(values = c(col2, col3)) +
  theme_ipsum_fsc() +
  xlab("Time") + ylab("Y")+
  theme(#panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        #panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.position = "blank")

```

---
# Sensitivity analysis for Diff-in-Diff

- Using a diff-in-diff strategy, we shouldn't find an effect

```{r dd_placebo2, fig.height=5, fig.width=6, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}

ggplot(data = dta, aes(x = time, y = y, color = factor(treat))) +
  geom_point(size = 3)+
  geom_line(lwd = 1) +
  geom_vline(aes(xintercept = 6), lty = 2, lwd = 0.8, color = "darkgrey") +
  geom_vline(aes(xintercept = 3), lty = 2, lwd = 1.1, color = col4) +
  ggplot2::annotate("text", x = 2, y = 15, label = "Placebo", size = 5, family = "Fira Sans Condensed",
                    color = col4) +
  scale_color_manual(values = c(col2, col3)) +
  theme_ipsum_fsc() +
  xlab("Time") + ylab("Y")+
  theme(#panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        #panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.position = "blank")

```

---
# Sensitivity analysis for Diff-in-Diff

- In an event study $\rightarrow$ null effects prior to the intervention:

```{r dd_placebo3, fig.height=5, fig.width=12, fig.align='center', dev='svg', echo=FALSE, warning=FALSE, message=FALSE}

g1 = ggplot(data = dta, aes(x = time, y = y, color = factor(treat))) +
  geom_point(size = 3)+
  geom_line(lwd = 1) +
  geom_vline(aes(xintercept = 6), lty = 2, lwd = 1.1, color = "darkgrey") +
  scale_color_manual(values = c(col2, col3)) +
  theme_ipsum_fsc() +
  xlab("Time") + ylab("Y")+
  theme(#panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        #panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.position = "blank")

set.seed(100)
dta_es = data.frame(time = 1:10,
                    est = c(rnorm(10, mean = 0, sd = 0.2)))

dta_es = dta_es %>% mutate(est = ifelse(time>=6, (time-6)*1.2, est),
                           cil = est - 1,
                           ciu = est + 1)
dta_es = dta_es %>% mutate(ciu = ifelse(time==6, 0, ciu),
                           cil = ifelse(time==6, 0, cil),
                           est = ifelse(time==6, 0, est))

g2 = ggplot(data = dta_es, aes(x = time, y = est)) +
  geom_vline(aes(xintercept = 6.5), lty = 2, lwd = 1, color = "darkgrey") +
  geom_hline(aes(yintercept = 0), lty = 1, lwd = 1, color = "darkgrey") +
  geom_segment(aes(x = time, xend = time, y = cil, yend = ciu), color = col4) +
  geom_point(color = col4, fill = alpha(col4, 0.3), pch = 21, size = 3) +
  theme_ipsum_fsc() + xlab("Time") + ylab("Est. Effect") +
    theme(#panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        #panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 16),
        legend.position = "blank")

g1 + g2
```

---
# Honest approach to test pretrends

- One main issue with the previous test $\rightarrow$ **.darkorange[Underpowered]**

--

- Rambachan & Roth (2023) propose **.darkorange[sensitivity bounds]** to allow pre-trends violations:

  - E.g. Violations in the post-intervention period can be _at most_ $M$ times the max violation in the pre-intervention period.

--

.center[
![:scale 80%](images/rambachan_roth2023.png)]

---
# Honest approach to test pretrends

- One drawback of the previous method is that it can **.darkorange[overstate]** (or understate) the robustness of findings if the point estimate is biased.

  - Honest CIs depend on the **.darkorange[magnitude of the point estimate]** as well as the **.darkorange[pre-trend violations]**.
  
--
<br>

- Matching can **.darkorange[reduce the overall bias]** of the point estimate

--
.center[
![](images/M_plot_beta6_ppt.svg)
]

---
# How do we match?

- Match on covariates or outcomes? Levels or trends?

- Propensity score matching? Optimal matching? etc.

--

This paper:

- **.darkorange[Match on time-invariant covariates]** that could make groups behave differently.
  
  - Use distribution of  covariates to match on a template.

- Use of **.darkorange[Mixed-Integer Programming (MIP) Matching]** .small[(Zubizarreta, 2015; Bennett, Zubizarreta, & Vielma, 2020)]:

  - Balance covariates directly
  
  - Yield largest matched sample under balancing constraints (cardinality matching)
  
  - Works fast with large samples

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
Simulations
<br>
<br>
]

---

# Different scenarios


For linear and quadratic functions:
<br>

.box-1trans[S1: No interaction between X and t]

.box-2trans[S2: Equal interaction between X and t]

.box-3trans[S3: Differential interaction between X and t]


Additional tests:
<br>

.box-4trans[S1b-S3b: Including time-varying covariates]

--
<br>

- For all scenarios, differential distribution of covariates $X$ between groups

---
# Data Generating Processes

.center[
![:scale 100%](images/table_sim.png)
]

---
#Parameters:

.center[
Parameter                            | Value
-------------------------------------|----------------------------------------------
Number of obs (N)                               | 1,000 
`Pr(Z=1)`              | 0.5 
Time periods (T)          | 8 
Last pre-intervention period (T_0)          | 4 
Matching PS          | Nearest neighbor (using calipers)
MIP Matching tolerance          | .01 SD
Number of simulations | 1,000
]

- Estimate compared to sample ATT (_can be different for matching_)

---
# S1 - No interaction between X and t

.center[
![Event study estimates by time period (wrt T=4) for no interaction between X and t](images/effect_beta_iter2_constant_effect1.svg)]

---
# S2 - Equal interaction between X and t by treatment

.center[
![Event study estimates by time period (wrt T=4) for equal interaction between X and t](images/effect_beta_iter6_constant_effect1.svg)]

---
# S3 - Differential interaction between X and t by treatment

.center[
![Event study estimates by time period (wrt T=4) for differential interaction between X and t](images/effect_beta_iter10_constant_effect1.svg)]

---
# Matching as an adjustment method for reducing/eliminating bias

.center[
![:scale 65%](images/bias_beta_summary_constant.svg)]

---
# Why is this bias reduction important?

- Example of S2 (Quadratic) with no true effect:

.center[
![Relative Magnitude Sensitivity Bounds on relative magnitudes for Scenario 2 (quadratic) - No effect](images/effect_beta_iter6_quad1_constant_effect0.svg)
]

---
# Why is this bias reduction important?

- Even under modest bias, we would incorrectly reject the null 20% of the time.

.center[
![Rejection rate of null hypothesis for different values of $\beta_x_t$](images/coverage_beta_quad1_original_PE_ppt.svg)]

---
# Why is this bias reduction important?

- Sensitivity analysis results are skewed by the magnitude of the bias.

.center[
![](images/coverage_beta_quad1_M_ppt.svg)]

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
Application
<br>
<br>
]
---
#Preferential Voucher Scheme in Chile

- Universal **.darkorange[flat voucher]** scheme $\stackrel{\mathbf{2008}}{\mathbf{\longrightarrow}}$ Universal + **.darkorange[preferential voucher]** scheme

- Preferential voucher scheme:
  - Targeted to bottom 40% of vulnerable students

  - Additional 50% of voucher per student

  - Additional money for concentration of SEP students.

--

<br/>
.pull-left[
.center[
.box-6trans[**Students:**<br/>- Verify SEP status<br/>- Attend a SEP school]
]
]

.pull-right[
.center[
.box-6trans[**Schools:**<br/>- Opt-into the policy<br/>- No selection, no fees<br/>- Resources ~ performance]
]
]

---
#Impact of the SEP policy

- **.darkorange[Mixed evidence of impact on test scores]** for lower-income students (Aguirre, 2022; Feigenberg et al., 2019; Neilson, 2016; Mizala & Torche, 2013)


---
#Impact of the SEP policy

- **.darkorange[Mixed evidence of impact on test scores]** for lower-income students (Aguirre, 2022; Feigenberg et al., 2019; Neilson, 2016; Mizala & Torche, 2013)


- Design could have **.darkorange[increased]** socioeconomic segregation (E.g. Incentives for concentration of SEP students)

---
#Impact of the SEP policy

- **.darkorange[Mixed evidence of impact on test scores]** for lower-income students (Aguirre, 2022; Feigenberg et al., 2019; Neilson, 2016; Mizala & Torche, 2013)


- Design could have **.darkorange[increased]** socioeconomic segregation (E.g. Incentives for concentration of SEP students)


- Key decision variables for schools: Performance, current SEP students, competition, add-on fees.

--

- **.darkorange[Diff-in-diff (w.r.t. 2007) for SEP and non-SEP schools]**:
  - Only for **.darkorange[private-subsidized schools]**
  
  - Matching using 2007 variables (similar results when using 2005-2007).
  
  - Outcome: Average students' household income and SIMCE score
  
---
#Before matching: Household income

.pull-left[
![](images/evolution_hh_income_all_ppt.svg)
]  

.pull-right[
![](images/hh_income_event_all_ppt.svg)
]

---
#Before matching: Average SIMCE

.pull-left[
![](images/evolution_simce_all_ppt.svg)
]  

.pull-right[
![](images/avg_simce_event_all_ppt.svg)
]

---
# Matching + DD

- **.darkorange[Prior to matching]**: No parallel pre-trend

- **.darkorange[Different types of schools]**:

  - Schools that charge high co-payment fees.
  
  - Schools with low number of SEP student enrolled.

- **.darkorange[MIP Matching]** using constant or "sticky" covariates:

  - Mean balance (0.025 SD): Enrollment, average yearly subsidy, number of voucher schools in county, charges add-on fees
  
  - Exact balance: Geographic province
  
---
# Groups are balanced in specific characteristics

.center[
![:scale 65%](images/loveplot.svg)]

---
# Matching in 16 out of 53 provinces 

.center[
![:scale 37%](images/map2b.png)]

---
# After matching: Household income

.pull-left[
![](images/evolution_hh_income_match_ppt.svg)
]  

.pull-right[
![](images/hh_income_event_matched_ppt.svg)
]

---
#After matching: Average SIMCE

.pull-left[
![](images/evolution_simce_match_ppt.svg)
]  

.pull-right[
![](images/avg_simce_event_matched_ppt.svg)
]

---
#Results

- **.darkorange[Matched schools]**:

  - More vulnerable and lower test scores than the population mean.
--

- **.darkorange[9pp increase in the income gap]** between SEP and non-SEP schools in matched DD:

  - SEP schools attracted even more vulnerable students.
  
  - Non-SEP schools increased their average family income.
--

- **.darkorange[No evidence of increase in SIMCE score]**:
  
  - Could be a longer-term outcome. 
--

- Findings in segregation are **.darkorange[moderately robust to hidden bias]** (Keele et al., 2019):
  
  - $\Gamma_c = 1.76$ $\rightarrow$ Unobserved confounder would have to change the probability of assignment from 50% vs 50% to 32.7% vs 67.3%.
  
  - Allows up to 70% of the maximum deviation in the pre-intervention period (*M = 0.7*) vs 50% without matching (Rambachan & Roth, 2023)
  
---
# Potential reasons?

- Increase in probability of becoming SEP in 2009 **.darkorange[jumps discontinuously at 60%]** of SEP student concentration in 2008 (4.7 pp; SE = 0.024)

.center[
![:scale 65%](images/rd_sep_concentration_ppt.svg)]

---
background-position: 50% 50%
class: left, bottom, inverse
.big[
Let's wrap it up
<br>
<br>
]
---
# Conclusions and Next Steps

.pull-left[
- Matching can be an important tool to address **.darkorange[violations in PTA]**.


- **.darkorange[Bias reduction]** is very important for sensitivity analysis.


- **.darkorange[Serial correlation]** also plays an important role: Don't match on random noise.


- Next steps: Partial identification using time-varying covariates]

.pull-right[
.center[
![](https://media.giphy.com/media/drwxYI2fxqQGqRZ9Pe/giphy.gif)]
]

---
class: inverse, center, middle

<br>
<br>
<br>

<h1 class="title-own">Difference-in-Differences<br/>using Mixed-Integer Programming Matching Approach</h1>

<br>
<br>
.small[Magdalena Bennett&nbsp;&nbsp;&nbsp;<br>*McCombs School of Business, The University of Texas at Austin*&nbsp;&nbsp;&nbsp;]

<br>

.small[AEFP 50th Conference, Washington DC<br>March 13th, 2025]

---
# SEP adoption over time

.center[
![](images/enrollment_sep_year_ppt.svg)
]
